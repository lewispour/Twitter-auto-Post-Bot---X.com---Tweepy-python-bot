{% extends "base.html" %}

{% block title %}Manage Tweets - Twitter Bot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-list-ul"></i> Manage Tweet Library
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Add New Tweet -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-plus-circle"></i> Add New Tweet
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="newTweet" class="form-label">Tweet Text</label>
                    <textarea class="form-control" id="newTweet" rows="3" maxlength="280" placeholder="Enter your tweet here..."></textarea>
                    <div class="form-text">
                        <span id="newTweetCharCount">0</span> / 280 characters
                    </div>
                </div>

                <button class="btn btn-primary" onclick="addTweet()">
                    <i class="bi bi-plus-lg"></i> Add Tweet
                </button>
            </div>
        </div>

        <!-- Tweet List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-collection"></i> Your Tweets ({{ tweets|length }})</span>
                <button class="btn btn-sm btn-outline-light" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="tweetsList">
                    {% if tweets %}
                        {% for tweet in tweets %}
                        <div class="tweet-box" id="tweet-{{ loop.index0 }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1 me-3">
                                    <div class="tweet-text" id="text-{{ loop.index0 }}">{{ tweet }}</div>
                                    <textarea class="form-control d-none" id="edit-{{ loop.index0 }}" rows="3">{{ tweet }}</textarea>
                                </div>
                                <div class="btn-group-vertical btn-group-sm">
                                    <button class="btn btn-outline-primary" id="edit-btn-{{ loop.index0 }}" onclick="editTweet({{ loop.index0 }})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-success d-none" id="save-btn-{{ loop.index0 }}" onclick="saveTweet({{ loop.index0 }})">
                                        <i class="bi bi-check"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary d-none" id="cancel-btn-{{ loop.index0 }}" onclick="cancelEdit({{ loop.index0 }})">
                                        <i class="bi bi-x"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteTweet({{ loop.index0 }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-muted small mt-2">
                                <i class="bi bi-hash"></i> Tweet {{ loop.index }}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No tweets in your library yet. Add some tweets above to get started!
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Info Sidebar -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> About Tweet Library
            </div>
            <div class="card-body">
                <p>Your tweet library is stored in <code>data/tweets.txt</code>.</p>

                <h6 class="mt-3"><i class="bi bi-lightbulb"></i> Usage:</h6>
                <ul class="small">
                    <li>Add multiple tweets to build your library</li>
                    <li>Use "Random from File" to post a random tweet</li>
                    <li>Schedule daily posts from your library</li>
                    <li>Edit or delete tweets anytime</li>
                </ul>

                <h6 class="mt-3"><i class="bi bi-trophy"></i> Tips:</h6>
                <ul class="small">
                    <li>Create a diverse set of tweets</li>
                    <li>Include different topics and styles</li>
                    <li>Keep them evergreen and timeless</li>
                    <li>Update regularly with fresh content</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Statistics
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Total Tweets:</strong> {{ tweets|length }}
                </div>
                <div class="mb-2">
                    <strong>Average Length:</strong>
                    {% if tweets %}
                        {{ (tweets | map('length') | sum / tweets | length) | round | int }} chars
                    {% else %}
                        0 chars
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Character counter for new tweet
    document.getElementById('newTweet').addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('newTweetCharCount').textContent = count;

        if (count > 280) {
            document.getElementById('newTweetCharCount').style.color = 'red';
        } else {
            document.getElementById('newTweetCharCount').style.color = '';
        }
    });

    async function addTweet() {
        const text = document.getElementById('newTweet').value.trim();

        if (!text) {
            showToast('Please enter some text for your tweet.', 'warning');
            return;
        }

        try {
            const response = await fetch('/add-tweet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tweet: text })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Tweet added successfully!', 'success');
                document.getElementById('newTweet').value = '';
                document.getElementById('newTweetCharCount').textContent = '0';
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error: ' + data.error, 'danger');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'danger');
        }
    }

    function editTweet(index) {
        document.getElementById(`text-${index}`).classList.add('d-none');
        document.getElementById(`edit-${index}`).classList.remove('d-none');
        document.getElementById(`edit-btn-${index}`).classList.add('d-none');
        document.getElementById(`save-btn-${index}`).classList.remove('d-none');
        document.getElementById(`cancel-btn-${index}`).classList.remove('d-none');
    }

    function cancelEdit(index) {
        document.getElementById(`text-${index}`).classList.remove('d-none');
        document.getElementById(`edit-${index}`).classList.add('d-none');
        document.getElementById(`edit-btn-${index}`).classList.remove('d-none');
        document.getElementById(`save-btn-${index}`).classList.add('d-none');
        document.getElementById(`cancel-btn-${index}`).classList.add('d-none');
    }

    async function saveTweet(index) {
        const text = document.getElementById(`edit-${index}`).value.trim();

        if (!text) {
            showToast('Tweet cannot be empty.', 'warning');
            return;
        }

        try {
            const response = await fetch('/update-tweet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index: index, text: text })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Tweet updated successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error: ' + data.error, 'danger');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'danger');
        }
    }

    async function deleteTweet(index) {
        if (!confirm('Are you sure you want to delete this tweet?')) {
            return;
        }

        try {
            const response = await fetch('/delete-tweet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index: index })
            });

            const data = await response.json();

            if (data.success) {
                showToast('Tweet deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error: ' + data.error, 'danger');
            }
        } catch (error) {
            showToast('Error: ' + error.message, 'danger');
        }
    }
</script>
{% endblock %}
